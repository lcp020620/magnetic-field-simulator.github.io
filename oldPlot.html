<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>3D Vector Graph Viewer</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="ui">
    <input type="file" id="csvFile" accept=".csv">
    <p>Status: <span id="status">Wait for file...</span></p>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- Scene 설정 ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 50;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    const grid = new THREE.GridHelper(100, 100);
    scene.add(grid);

    // --- CSV 데이터 처리 ---
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                renderVectors(results.data);
            }
        });
    });

    // --- 벡터 렌더링 함수 ---
    function renderVectors(data) {
        document.getElementById('status').innerText = `Rendering ${data.length} points...`;
        
        // 기존 객체 삭제 (재로드 시)
        scene.children = scene.children.filter(c => !(c instanceof THREE.ArrowHelper));

        // 성능 최적화 팁: 10,000개라면 ArrowHelper도 괜찮지만, 
        // 10만개 이상이면 InstancedMesh를 권장합니다.
        data.forEach(row => {
            if(row.x !== undefined && row.vx !== undefined) {
                const pos = new THREE.Vector3(row.x, row.y, row.z);
                const dir = new THREE.Vector3(row.vx, row.vy, row.vz).normalize();
                const length = Math.log(Math.sqrt(row.vx**2 + row.vy**2 + row.vz**2)); //이 부분 변경해서 화살표 길이 바꾸는 것 가능함.
                
                const arrowHelper = new THREE.ArrowHelper(dir, pos, length, 0x00ffcc);
                scene.add(arrowHelper);
            }
        });
        document.getElementById('status').innerText = "Done.";
    }

    // --- 애니메이션 루프 ---
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    // 창 크기 조절 대응
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>